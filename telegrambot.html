<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å‚³è¨Šæ¯çµ¦æˆ‘</title>
  <style>
    :root {
      --bg-color: #f5f6fa;
      --text-color: #333;
      --card-bg: #ffffff;
      --input-bg: #fff;
      --input-border: #ccc;
      --btn-bg: #2f80ed;
      --btn-hover: #1c60c6;
      --progress-bg: #e0e0e0;
      --progress-fill: #4caf50;
    }
    [data-theme="dark"] {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --card-bg: #1e1e1e;
      --input-bg: #2a2a2a;
      --input-border: #555;
      --btn-bg: #4a75d1;
      --btn-hover: #2e4e9f;
      --progress-bg: #444;
      --progress-fill: #4caf50;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px 0;
    }
    .container {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 450px;
      text-align: center;
      position: relative;
    }
    .toggle {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      
    }
    .toggle input {
      display: none;
    }
    .toggle-label {
      width: 40px;
      height: 20px;
      background: #ccc;
      border-radius: 10px;
      position: relative;
      transition: background 0.3s;
    }
    [data-theme="dark"] .toggle-label {
      background: #666;
    }
    .toggle-label::after {
      content: '';
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    input:checked + .toggle-label::after {
      transform: translateX(20px);
    }
    input:checked + .toggle-label {
      background: #4a75d1;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 20px;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 1rem;
      font-size: 1rem;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-color);
    }
    .upload-btn {
      display: inline-block;
      padding: 12px 20px;
      font-size: 1rem;
      background-color: var(--btn-bg);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.2s ease;
      
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .upload-btn:hover {
      background-color: var(--btn-hover);
    }
    .file-input {
      display: none;
    }
    button {
      padding: 12px 20px;
      font-size: 1rem;
      background-color: var(--btn-bg);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.2s ease;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background-color: var(--btn-hover);
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .progress-container {
      width: 100%;
      background-color: var(--progress-bg);
      border-radius: 5px;
      margin: 10px 0;
      height: 8px;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      width: 0%;
      height: 100%;
      background-color: var(--progress-fill);
      transition: width 0.1s;
    }
    .tab-container {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--input-border);
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      flex: 1;
      text-align: center;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    .tab.active {
      border-bottom: 3px solid var(--btn-bg);
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .file-info {
      font-size: 0.9rem;
      margin: 10px 0;
      text-align: left;
      word-break: break-all;
    }
    /* æ‹–æ”¾å€åŸŸæ¨£å¼ */
    .drop-area {
      border: 2px dashed var(--input-border);
      border-radius: 8px;
      padding: 30px 20px;
      text-align: center;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      background-color: var(--input-bg);
      color: var(--text-color);
    }
    .drop-area.active {
      border-color: var(--btn-bg);
      background-color: rgba(47, 128, 237, 0.1);
    }
    .drop-area-text {
      font-size: 1rem;
      margin-bottom: 10px;
    }
    .drop-area-icon {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--input-border);
    }
    .drop-area.active .drop-area-icon {
      color: var(--btn-bg);
    }
    /* æ–°å¢ç½²åå€å¡Šæ¨£å¼ */
    .name-input {
      margin-bottom: 12px;
    }
    .name-label {
      display: block;
      text-align: left;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <label class="toggle">
      <input type="checkbox" id="modeToggle">
      <span class="toggle-label"></span>
    </label>
    
    <h2>å‚³è¨Šæ¯çµ¦æˆ‘</h2>
    
    <div class="tab-container">
      <div class="tab active" data-tab="text-tab">æ–‡å­—</div>
      <div class="tab" data-tab="file-tab">æª”æ¡ˆï¼ˆå‚³åœ–æˆ–pdfï¼‰</div>
    </div>
    
    <!-- ç½²åè¼¸å…¥æ¡† - å…±ç”¨å€å¡Š -->
    <div class="name-input">
      <label for="senderName" class="name-label">æ‚¨çš„ç½²åï¼š</label>
      <input id="senderName" type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“åï¼ˆé¸å¡«ï¼‰" />
    </div>
    
    <div id="text-tab" class="tab-content active">
      <input id="msg" type="text" placeholder="è¼¸å…¥è¨Šæ¯" />
      <button id="sendTextBtn" onclick="sendText()">é€å‡ºæ–‡å­—</button>
    </div>
    
    <div id="file-tab" class="tab-content">
      <!-- æ–°å¢æ‹–æ”¾å€åŸŸ -->
      <div id="dropArea" class="drop-area">
        <div class="drop-area-icon">ğŸ“</div>
        <div class="drop-area-text">æ‹–æ”¾æª”æ¡ˆåˆ°æ­¤è™•</div>
        <div class="drop-area-text">æˆ–</div>
      </div>
      
      <label for="imageInput" class="upload-btn" style="margin-bottom: 8px;">é¸æ“‡åœ–ç‰‡ï¼ˆå‚³åœ–ç‰‡é»é€™å€‹ï¼‰</label>
      <input id="imageInput" class="file-input" type="file" accept="image/*" onchange="handleImageSelection()" />
      <label for="fileInput" class="upload-btn">é¸æ“‡æª”æ¡ˆï¼ˆå¦‚æœè¦å‚³pdfé»é€™å€‹ï¼‰</label>
      <input id="fileInput" class="file-input" type="file" onchange="previewFile()" />
      
      <div class="file-info" id="fileInfo"></div>
      <img id="preview" style="max-width: 100%; margin: 10px 0; display: none; border-radius: 8px;" />
      
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      
      <button id="sendFileBtn" onclick="sendFile()">é€å‡ºï¼ˆæŒ‰é€™å€‹å°±ç™¼çµ¦æˆ‘ï¼‰</button>
    </div>
    
    <div id="status" style="margin-top: 15px; font-size: 0.9rem;"></div>
  </div>
  
  <script>
    // API ç«¯é»åŸºç¤ URL
    const API_BASE_URL = 'https://telegrambotmessage.potatomatoyota.workers.dev';
    
    // æ·±è‰²/æ·ºè‰²æ¨¡å¼åˆ‡æ›
    const toggle = document.getElementById('modeToggle');
    const root = document.documentElement;
    const saved = localStorage.getItem('theme') || 'light';
    root.setAttribute('data-theme', saved);
    toggle.checked = saved === 'dark';
  
    toggle.addEventListener('change', () => {
      const mode = toggle.checked ? 'dark' : 'light';
      root.setAttribute('data-theme', mode);
      localStorage.setItem('theme', mode);
    });
    
    // æ¨™ç±¤é åˆ‡æ›
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        
        // ç§»é™¤æ‰€æœ‰æ¨™ç±¤å’Œå…§å®¹çš„æ´»å‹•ç‹€æ…‹
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // è¨­ç½®ç•¶å‰æ¨™ç±¤å’Œå…§å®¹ç‚ºæ´»å‹•ç‹€æ…‹
        tab.classList.add('active');
        document.getElementById(tabId).classList.add('active');
      });
    });
    
    // å„²å­˜ç½²ååˆ°æœ¬åœ°å­˜å„²
    document.getElementById('senderName').addEventListener('input', function() {
      localStorage.setItem('senderName', this.value);
    });
    
    // è¼‰å…¥å„²å­˜çš„ç½²å
    window.addEventListener('DOMContentLoaded', () => {
      const savedName = localStorage.getItem('senderName');
      if (savedName) {
        document.getElementById('senderName').value = savedName;
      }
    });
    
    // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
    function showStatus(msg, success = true) {
      const status = document.getElementById("status");
      status.style.color = success ? "green" : "red";
      status.innerText = msg;
    }
    
    // è¨­ç½®é€²åº¦æ¢
    function setProgressBar(percent) {
      const progressBar = document.getElementById("progressBar");
      progressBar.style.width = percent + "%";
    }
    
    // é¡¯ç¤ºé€²åº¦æ¢
    function showProgressBar(show = true) {
      const progressContainer = document.getElementById("progressContainer");
      progressContainer.style.display = show ? "block" : "none";
      if (show) {
        setProgressBar(0);
      }
    }
    
    // ç²å–ç½²å
    function getSenderName() {
      const nameField = document.getElementById("senderName");
      const name = nameField.value.trim();
      return name ? `ã€${name}ã€‘` : "";
    }
    
    // ç™¼é€æ–‡å­—è¨Šæ¯
    async function sendText() {
      const btn = document.getElementById("sendTextBtn");
      const msgEl = document.getElementById("msg");
      const msg = msgEl.value.trim();
      if (!msg) return showStatus("è«‹è¼¸å…¥è¨Šæ¯", false);
      
      const senderPrefix = getSenderName();
      const fullMessage = senderPrefix ? `${senderPrefix} ${msg}` : msg;
  
      btn.disabled = true;
      btn.innerText = "å‚³é€ä¸­...";
  
      try {
        const res = await fetch(`${API_BASE_URL}/sendText`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: fullMessage })
        });
        const data = await res.json();
        if (data.ok) {
          showStatus("æ–‡å­—è¨Šæ¯å·²é€å‡ºï¼");
          msgEl.value = '';
        } else {
          showStatus("ç™¼é€å¤±æ•—ï¼š" + (data.description || data.error || JSON.stringify(data)), false);
        }
      } catch (err) {
        showStatus("éŒ¯èª¤ï¼š" + err.message, false);
      }
  
      btn.disabled = false;
      btn.innerText = "é€å‡ºæ–‡å­—";
    }
    
    function handleImageSelection() {
      const imageInput = document.getElementById("imageInput");
      const fileInput = document.getElementById("fileInput");

      if (imageInput.files.length > 0) {
        const file = imageInput.files[0];

        // å°‡é¸åˆ°çš„åœ–ç‰‡è¤‡è£½åˆ°åŸæœ¬ fileInput
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;

        previewFile();
      }
    }
    
    // é è¦½æ–‡ä»¶
    function previewFile() {
      const fileInput = document.getElementById("fileInput");
      const preview = document.getElementById("preview");
      const fileInfo = document.getElementById("fileInfo");
      const file = fileInput.files[0];
      
      if (!file) {
        preview.style.display = "none";
        fileInfo.innerHTML = "";
        return;
      }
      
      // é¡¯ç¤ºæª”æ¡ˆä¿¡æ¯
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      fileInfo.innerHTML = `
        <strong>æª”æ¡ˆåç¨±:</strong> ${file.name}<br/>
        <strong>æª”æ¡ˆé¡å‹:</strong> ${file.type || 'æœªçŸ¥'}<br/>
        <strong>æª”æ¡ˆå¤§å°:</strong> ${sizeMB} MB
      `;
      
      // å¦‚æœæ˜¯åœ–ç‰‡ï¼Œé¡¯ç¤ºé è¦½
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = () => {
          preview.src = reader.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.style.display = "none";
      }
    }
    
    // æ ¹æ“šæª”æ¡ˆé¡å‹ç²å–ç«¯é»
    function getEndpointForFile(file) {
      if (file.type.startsWith('image/')) {
        return 'sendPhoto';
      } else if (file.type.startsWith('video/')) {
        return 'sendVideo';
      } else if (file.type.startsWith('audio/')) {
        return 'sendAudio';
      } else {
        return 'sendDocument';
      }
    }
    
    // ç™¼é€æª”æ¡ˆ
    async function sendFile() {
      const btn = document.getElementById("sendFileBtn");
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      if (!file) return showStatus("è«‹é¸æ“‡æª”æ¡ˆ", false);
      
      btn.disabled = true;
      btn.innerText = "å‚³é€ä¸­...";
      showProgressBar(true);
      
      try {
        const endpoint = getEndpointForFile(file);
        const senderPrefix = getSenderName();
        
        // æª”æ¡ˆå°æ–¼ 10MBï¼Œç›´æ¥ä¸Šå‚³
        if (file.size <= 10 * 1024 * 1024) {
          const formData = new FormData();
          const fileKey = endpoint.replace('send', '').toLowerCase();
          formData.append(fileKey, file);
          // æ·»åŠ ç½²ååˆ°æª”æ¡ˆèªªæ˜ä¸­
          const caption = senderPrefix ? `${senderPrefix} ${file.name}` : file.name;
          formData.append("caption", caption);
          
          const res = await fetch(`${API_BASE_URL}/${endpoint}`, {
            method: 'POST',
            body: formData
          });
          
          const data = await res.json();
          if (data.ok) {
            showStatus("æª”æ¡ˆå·²é€å‡ºï¼");
            fileInput.value = '';
            document.getElementById("preview").style.display = "none";
            document.getElementById("fileInfo").innerHTML = "";
          } else {
            throw new Error(data.description || data.error || JSON.stringify(data));
          }
        } else {
          // æª”æ¡ˆå¤§æ–¼ 10MBï¼Œä½¿ç”¨åˆ†ç‰‡ä¸Šå‚³
          await chunkedUpload(file, endpoint, senderPrefix);
        }
      } catch (err) {
        showStatus("éŒ¯èª¤ï¼š" + err.message, false);
      }
      
      showProgressBar(false);
      btn.disabled = false;
      btn.innerText = "é€å‡ºï¼ˆæŒ‰é€™å€‹å°±ç™¼çµ¦æˆ‘ï¼‰";
    }
    
    // åˆ†ç‰‡ä¸Šå‚³å¤§æª”æ¡ˆ
    async function chunkedUpload(file, endpoint, senderPrefix) {
      const chunkSize = 4* 1024 * 1024; // 4MB æ¯ç‰‡
      const totalChunks = Math.ceil(file.size / chunkSize);
      const fileId = Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9); // ç”Ÿæˆå”¯ä¸€çš„æª”æ¡ˆID
      
      for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
        const start = chunkIndex * chunkSize;
        const end = Math.min(file.size, start + chunkSize);
        const chunk = file.slice(start, end);
        
        const formData = new FormData();
        formData.append("file", chunk);
        formData.append("fileName", file.name);
        formData.append("fileType", file.type);
        formData.append("fileId", fileId);
        formData.append("chunkIndex", chunkIndex);
        formData.append("totalChunks", totalChunks);
        formData.append("endpoint", endpoint);
        // æ·»åŠ ç½²åä¿¡æ¯
        formData.append("senderName", senderPrefix);
        
        const percent = Math.round((chunkIndex + 1) / totalChunks * 100);
        setProgressBar(percent);
        showStatus(`ä¸Šå‚³é€²åº¦: ${percent}%`);
        
        try {
          const response = await fetch(`${API_BASE_URL}/uploadChunk`, {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          if (!data.ok && data.error) {
            throw new Error(data.error);
          }
          
          // å¦‚æœæ˜¯æœ€å¾Œä¸€å€‹åˆ†ç‰‡ï¼Œå‰‡å®Œæˆä¸Šå‚³
          if (chunkIndex === totalChunks - 1) {
            const completeRes = await fetch(`${API_BASE_URL}/completeUpload`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                fileId,
                fileName: file.name,
                fileType: file.type,
                totalChunks,
                endpoint,
                senderName: senderPrefix // åŠ å…¥ç½²å
              })
            });
            
            const completeData = await completeRes.json();
            if (completeData.ok) {
              showStatus("æª”æ¡ˆå·²ä¸Šå‚³ä¸¦ç™¼é€ï¼");
              document.getElementById("fileInput").value = '';
              document.getElementById("preview").style.display = "none";
              document.getElementById("fileInfo").innerHTML = "";
            } else {
              throw new Error(completeData.description || completeData.error || "å®Œæˆä¸Šå‚³å¤±æ•—");
            }
          }
        } catch (error) {
          throw new Error(`åˆ†ç‰‡ ${chunkIndex + 1}/${totalChunks} ä¸Šå‚³å¤±æ•—: ${error.message}`);
        }
      }
    }
    
    // è¨­ç½®æ‹–æ”¾åŠŸèƒ½
    const dropArea = document.getElementById('dropArea');
    
    // é˜²æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    // æ‹–æ›³æ•ˆæœ
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
      dropArea.classList.add('active');
    }
    
    function unhighlight() {
      dropArea.classList.remove('active');
    }
    
    // è™•ç†æ‹–æ”¾
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        const file = files[0]; // åªè™•ç†ç¬¬ä¸€å€‹æª”æ¡ˆ
        
        // å°‡æª”æ¡ˆè¨­ç½®åˆ° fileInput
        const fileInput = document.getElementById('fileInput');
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        
        // é è¦½æª”æ¡ˆ
        previewFile();
        
        // å¦‚æœæ˜¯åœ–ç‰‡ï¼Œä¹Ÿè¨­ç½®åˆ° imageInput
        if (file.type.startsWith('image/')) {
          const imageInput = document.getElementById('imageInput');
          imageInput.files = dataTransfer.files;
        }
        
        // é¡¯ç¤ºæª”æ¡ˆå·²æ‹–æ”¾çš„ç‹€æ…‹
        showStatus(`å·²é¸æ“‡æª”æ¡ˆ: ${file.name}`);
      }
    }
  </script>
</body>
</html>

curl --location --request POST 'https://api.dropboxapi.com/oauth2/token' \
-u 'murf4769h6lcpkn:xg6gqkq8tx2av1i'
-H 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'code=5whPI3onBFoAAAAAAAAAQkx7U_redT3zU-Kd3j1D9VY' \
--data-urlencode 'grant_type=authorization_code'