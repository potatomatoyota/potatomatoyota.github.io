<!DOCTYPE html>
<html lang="zh-TW" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>傳訊息給我</title>
  <style>
    :root {
      --bg-color: #f5f6fa;
      --text-color: #333;
      --card-bg: #ffffff;
      --input-bg: #fff;
      --input-border: #ccc;
      --btn-bg: #2f80ed;
      --btn-hover: #1c60c6;
      --progress-bg: #e0e0e0;
      --progress-fill: #4caf50;
    }
    [data-theme="dark"] {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --card-bg: #1e1e1e;
      --input-bg: #2a2a2a;
      --input-border: #555;
      --btn-bg: #4a75d1;
      --btn-hover: #2e4e9f;
      --progress-bg: #444;
      --progress-fill: #4caf50;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px 0;
    }
    .container {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 450px;
      text-align: center;
      position: relative;
    }
    .toggle {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
      
    }
    .toggle input {
      display: none;
    }
    .toggle-label {
      width: 40px;
      height: 20px;
      background: #ccc;
      border-radius: 10px;
      position: relative;
      transition: background 0.3s;
    }
    [data-theme="dark"] .toggle-label {
      background: #666;
    }
    .toggle-label::after {
      content: '';
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }
    input:checked + .toggle-label::after {
      transform: translateX(20px);
    }
    input:checked + .toggle-label {
      background: #4a75d1;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 20px;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 1rem;
      font-size: 1rem;
      border: 1px solid var(--input-border);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--text-color);
    }
    .upload-btn {
      display: inline-block;
      padding: 12px 20px;
      font-size: 1rem;
      background-color: var(--btn-bg);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.2s ease;
      
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .upload-btn:hover {
      background-color: var(--btn-hover);
    }
    .file-input {
      display: none;
    }
    button {
      padding: 12px 20px;
      font-size: 1rem;
      background-color: var(--btn-bg);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: background-color 0.2s ease;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background-color: var(--btn-hover);
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .progress-container {
      width: 100%;
      background-color: var(--progress-bg);
      border-radius: 5px;
      margin: 10px 0;
      height: 8px;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      width: 0%;
      height: 100%;
      background-color: var(--progress-fill);
      transition: width 0.1s;
    }
    .tab-container {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--input-border);
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      flex: 1;
      text-align: center;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    .tab.active {
      border-bottom: 3px solid var(--btn-bg);
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .file-info {
      font-size: 0.9rem;
      margin: 10px 0;
      text-align: left;
      word-break: break-all;
    }
    /* 拖放區域樣式 */
    .drop-area {
      border: 2px dashed var(--input-border);
      border-radius: 8px;
      padding: 30px 20px;
      text-align: center;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      background-color: var(--input-bg);
      color: var(--text-color);
    }
    .drop-area.active {
      border-color: var(--btn-bg);
      background-color: rgba(47, 128, 237, 0.1);
    }
    .drop-area-text {
      font-size: 1rem;
      margin-bottom: 10px;
    }
    .drop-area-icon {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--input-border);
    }
    .drop-area.active .drop-area-icon {
      color: var(--btn-bg);
    }
    /* 新增署名區塊樣式 */
    .name-input {
      margin-bottom: 12px;
    }
    .name-label {
      display: block;
      text-align: left;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <label class="toggle">
      <input type="checkbox" id="modeToggle">
      <span class="toggle-label"></span>
    </label>
    
    <h2>傳訊息給我</h2>
    
    <div class="tab-container">
      <div class="tab active" data-tab="text-tab">文字</div>
      <div class="tab" data-tab="file-tab">檔案（傳圖或pdf）</div>
    </div>
    
    <!-- 署名輸入框 - 共用區塊 -->
    <div class="name-input">
      <label for="senderName" class="name-label">您的署名：</label>
      <input id="senderName" type="text" placeholder="請輸入您的姓名（選填）" />
    </div>
    
    <div id="text-tab" class="tab-content active">
      <input id="msg" type="text" placeholder="輸入訊息" />
      <button id="sendTextBtn" onclick="sendText()">送出文字</button>
    </div>
    
    <div id="file-tab" class="tab-content">
      <!-- 新增拖放區域 -->
      <div id="dropArea" class="drop-area">
        <div class="drop-area-icon">📁</div>
        <div class="drop-area-text">拖放檔案到此處</div>
        <div class="drop-area-text">或</div>
      </div>
      
      <label for="imageInput" class="upload-btn" style="margin-bottom: 8px;">選擇圖片（傳圖片點這個）</label>
      <input id="imageInput" class="file-input" type="file" accept="image/*" onchange="handleImageSelection()" />
      <label for="fileInput" class="upload-btn">選擇檔案（如果要傳pdf點這個）</label>
      <input id="fileInput" class="file-input" type="file" onchange="previewFile()" />
      
      <div class="file-info" id="fileInfo"></div>
      <img id="preview" style="max-width: 100%; margin: 10px 0; display: none; border-radius: 8px;" />
      
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      
      <button id="sendFileBtn" onclick="sendFile()">送出（按這個就發給我）</button>
    </div>
    
    <div id="status" style="margin-top: 15px; font-size: 0.9rem;"></div>
  </div>
  
  <script>
    // API 端點基礎 URL
    const API_BASE_URL = 'https://telegrambotmessage.potatomatoyota.workers.dev';
    
    // 深色/淺色模式切換
    const toggle = document.getElementById('modeToggle');
    const root = document.documentElement;
    const saved = localStorage.getItem('theme') || 'light';
    root.setAttribute('data-theme', saved);
    toggle.checked = saved === 'dark';
  
    toggle.addEventListener('change', () => {
      const mode = toggle.checked ? 'dark' : 'light';
      root.setAttribute('data-theme', mode);
      localStorage.setItem('theme', mode);
    });
    
    // 標籤頁切換
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        
        // 移除所有標籤和內容的活動狀態
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // 設置當前標籤和內容為活動狀態
        tab.classList.add('active');
        document.getElementById(tabId).classList.add('active');
      });
    });
    
    // 儲存署名到本地存儲
    document.getElementById('senderName').addEventListener('input', function() {
      localStorage.setItem('senderName', this.value);
    });
    
    // 載入儲存的署名
    window.addEventListener('DOMContentLoaded', () => {
      const savedName = localStorage.getItem('senderName');
      if (savedName) {
        document.getElementById('senderName').value = savedName;
      }
    });
    
    // 顯示狀態訊息
    function showStatus(msg, success = true) {
      const status = document.getElementById("status");
      status.style.color = success ? "green" : "red";
      status.innerText = msg;
    }
    
    // 設置進度條
    function setProgressBar(percent) {
      const progressBar = document.getElementById("progressBar");
      progressBar.style.width = percent + "%";
    }
    
    // 顯示進度條
    function showProgressBar(show = true) {
      const progressContainer = document.getElementById("progressContainer");
      progressContainer.style.display = show ? "block" : "none";
      if (show) {
        setProgressBar(0);
      }
    }
    
    // 獲取署名
    function getSenderName() {
      const nameField = document.getElementById("senderName");
      const name = nameField.value.trim();
      return name ? `【${name}】` : "";
    }
    
    // 發送文字訊息
    async function sendText() {
      const btn = document.getElementById("sendTextBtn");
      const msgEl = document.getElementById("msg");
      const msg = msgEl.value.trim();
      if (!msg) return showStatus("請輸入訊息", false);
      
      const senderPrefix = getSenderName();
      const fullMessage = senderPrefix ? `${senderPrefix} ${msg}` : msg;
  
      btn.disabled = true;
      btn.innerText = "傳送中...";
  
      try {
        const res = await fetch(`${API_BASE_URL}/sendText`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: fullMessage })
        });
        const data = await res.json();
        if (data.ok) {
          showStatus("文字訊息已送出！");
          msgEl.value = '';
        } else {
          showStatus("發送失敗：" + (data.description || data.error || JSON.stringify(data)), false);
        }
      } catch (err) {
        showStatus("錯誤：" + err.message, false);
      }
  
      btn.disabled = false;
      btn.innerText = "送出文字";
    }
    
    function handleImageSelection() {
      const imageInput = document.getElementById("imageInput");
      const fileInput = document.getElementById("fileInput");

      if (imageInput.files.length > 0) {
        const file = imageInput.files[0];

        // 將選到的圖片複製到原本 fileInput
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;

        previewFile();
      }
    }
    
    // 預覽文件
    function previewFile() {
      const fileInput = document.getElementById("fileInput");
      const preview = document.getElementById("preview");
      const fileInfo = document.getElementById("fileInfo");
      const file = fileInput.files[0];
      
      if (!file) {
        preview.style.display = "none";
        fileInfo.innerHTML = "";
        return;
      }
      
      // 顯示檔案信息
      const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
      fileInfo.innerHTML = `
        <strong>檔案名稱:</strong> ${file.name}<br/>
        <strong>檔案類型:</strong> ${file.type || '未知'}<br/>
        <strong>檔案大小:</strong> ${sizeMB} MB
      `;
      
      // 如果是圖片，顯示預覽
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = () => {
          preview.src = reader.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.style.display = "none";
      }
    }
    
    // 根據檔案類型獲取端點
    function getEndpointForFile(file) {
      if (file.type.startsWith('image/')) {
        return 'sendPhoto';
      } else if (file.type.startsWith('video/')) {
        return 'sendVideo';
      } else if (file.type.startsWith('audio/')) {
        return 'sendAudio';
      } else {
        return 'sendDocument';
      }
    }
    
    // 發送檔案
    async function sendFile() {
      const btn = document.getElementById("sendFileBtn");
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      if (!file) return showStatus("請選擇檔案", false);
      
      btn.disabled = true;
      btn.innerText = "傳送中...";
      showProgressBar(true);
      
      try {
        const endpoint = getEndpointForFile(file);
        const senderPrefix = getSenderName();
        
        // 檔案小於 10MB，直接上傳
        if (file.size <= 10 * 1024 * 1024) {
          const formData = new FormData();
          const fileKey = endpoint.replace('send', '').toLowerCase();
          formData.append(fileKey, file);
          // 添加署名到檔案說明中
          const caption = senderPrefix ? `${senderPrefix} ${file.name}` : file.name;
          formData.append("caption", caption);
          
          const res = await fetch(`${API_BASE_URL}/${endpoint}`, {
            method: 'POST',
            body: formData
          });
          
          const data = await res.json();
          if (data.ok) {
            showStatus("檔案已送出！");
            fileInput.value = '';
            document.getElementById("preview").style.display = "none";
            document.getElementById("fileInfo").innerHTML = "";
          } else {
            throw new Error(data.description || data.error || JSON.stringify(data));
          }
        } else {
          // 檔案大於 10MB，使用分片上傳
          await chunkedUpload(file, endpoint, senderPrefix);
        }
      } catch (err) {
        showStatus("錯誤：" + err.message, false);
      }
      
      showProgressBar(false);
      btn.disabled = false;
      btn.innerText = "送出（按這個就發給我）";
    }
    
    // 分片上傳大檔案
    async function chunkedUpload(file, endpoint, senderPrefix) {
      const chunkSize = 4* 1024 * 1024; // 4MB 每片
      const totalChunks = Math.ceil(file.size / chunkSize);
      const fileId = Date.now().toString() + '-' + Math.random().toString(36).substr(2, 9); // 生成唯一的檔案ID
      
      for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
        const start = chunkIndex * chunkSize;
        const end = Math.min(file.size, start + chunkSize);
        const chunk = file.slice(start, end);
        
        const formData = new FormData();
        formData.append("file", chunk);
        formData.append("fileName", file.name);
        formData.append("fileType", file.type);
        formData.append("fileId", fileId);
        formData.append("chunkIndex", chunkIndex);
        formData.append("totalChunks", totalChunks);
        formData.append("endpoint", endpoint);
        // 添加署名信息
        formData.append("senderName", senderPrefix);
        
        const percent = Math.round((chunkIndex + 1) / totalChunks * 100);
        setProgressBar(percent);
        showStatus(`上傳進度: ${percent}%`);
        
        try {
          const response = await fetch(`${API_BASE_URL}/uploadChunk`, {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          if (!data.ok && data.error) {
            throw new Error(data.error);
          }
          
          // 如果是最後一個分片，則完成上傳
          if (chunkIndex === totalChunks - 1) {
            const completeRes = await fetch(`${API_BASE_URL}/completeUpload`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                fileId,
                fileName: file.name,
                fileType: file.type,
                totalChunks,
                endpoint,
                senderName: senderPrefix // 加入署名
              })
            });
            
            const completeData = await completeRes.json();
            if (completeData.ok) {
              showStatus("檔案已上傳並發送！");
              document.getElementById("fileInput").value = '';
              document.getElementById("preview").style.display = "none";
              document.getElementById("fileInfo").innerHTML = "";
            } else {
              throw new Error(completeData.description || completeData.error || "完成上傳失敗");
            }
          }
        } catch (error) {
          throw new Error(`分片 ${chunkIndex + 1}/${totalChunks} 上傳失敗: ${error.message}`);
        }
      }
    }
    
    // 設置拖放功能
    const dropArea = document.getElementById('dropArea');
    
    // 防止瀏覽器預設行為
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    // 拖曳效果
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
      dropArea.classList.add('active');
    }
    
    function unhighlight() {
      dropArea.classList.remove('active');
    }
    
    // 處理拖放
    dropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        const file = files[0]; // 只處理第一個檔案
        
        // 將檔案設置到 fileInput
        const fileInput = document.getElementById('fileInput');
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        
        // 預覽檔案
        previewFile();
        
        // 如果是圖片，也設置到 imageInput
        if (file.type.startsWith('image/')) {
          const imageInput = document.getElementById('imageInput');
          imageInput.files = dataTransfer.files;
        }
        
        // 顯示檔案已拖放的狀態
        showStatus(`已選擇檔案: ${file.name}`);
      }
    }
  </script>
</body>
</html>

curl --location --request POST 'https://api.dropboxapi.com/oauth2/token' \
-u 'murf4769h6lcpkn:xg6gqkq8tx2av1i'
-H 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'code=5whPI3onBFoAAAAAAAAAQkx7U_redT3zU-Kd3j1D9VY' \
--data-urlencode 'grant_type=authorization_code'