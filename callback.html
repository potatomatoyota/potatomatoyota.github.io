<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>正在登入...</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
<script>
  const API_KEY = '244ed7c6297e19a27b7dd55161df8069';
  const API_SECRET = '3694f958b03509a51f7d2957b27ae75c';
  const token = new URLSearchParams(window.location.search).get('token');

  if (token) {
    const params = {
      method: 'auth.getSession',
      api_key: API_KEY,
      token: token
    };

    // 排序後加上 API_SECRET
    const keys = Object.keys(params).sort();
    let sig = '';
    for (const key of keys) {
      sig += key + params[key];
    }
    sig += API_SECRET;
    const api_sig = CryptoJS.MD5(sig).toString();

    fetch(`https://ws.audioscrobbler.com/2.0/?method=auth.getSession&api_key=${API_KEY}&token=${token}&api_sig=${api_sig}&format=json`)
      .then(res => res.json())
      .then(data => {
        if (data.session?.key) {
          localStorage.setItem('lastfm_session_key', data.session.key);
          alert('登入成功！可以回到主頁使用讚功能');
          window.location.href = '/'; // 回到你的主頁
        } else {
          alert('取得 session key 失敗');
        }
      }).catch(err => {
        console.error('登入失敗:', err);
        alert('登入發生錯誤');
      });
  } else {
    alert('找不到 token');
  }
</script>
</body>
</html>
