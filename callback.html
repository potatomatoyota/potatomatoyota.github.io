<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>登入中...</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <p>正在登入 Last.fm，請稍候...</p>
  <script>
    const API_KEY = '你的API_KEY';
    const API_SECRET = '你的API_SECRET';

    const token = new URLSearchParams(window.location.search).get('token');

    if (!token) {
      alert('登入失敗，缺少 token');
    } else {
      const params = {
        method: 'auth.getSession',
        api_key: API_KEY,
        token: token
      };

      const sortedKeys = Object.keys(params).sort();
      let sig = '';
      for (const key of sortedKeys) {
        sig += key + params[key];
      }
      sig += API_SECRET;

      const api_sig = CryptoJS.MD5(sig).toString();

      fetch(`https://ws.audioscrobbler.com/2.0/?method=auth.getSession&api_key=${API_KEY}&token=${token}&api_sig=${api_sig}&format=json`)
        .then(res => res.json())
        .then(data => {
          if (data.session?.key) {
            localStorage.setItem('lastfm_session_key', data.session.key);
            alert('登入成功！你可以回去按讚了！');
            window.location.href = '/'; // 回到你的主頁
          } else {
            alert('取得 session key 失敗：' + JSON.stringify(data));
          }
        }).catch(err => {
          console.error('發生錯誤:', err);
          alert('交換 session key 時失敗');
        });
    }
  </script>
</body>
</html>
