<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700&display=swap" rel="stylesheet">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="img/Favicon.png" type="image/x-icon">
  <title>lastfm</title>

  <style>
    * {
      font-family: 'Noto Sans TC', 'Noto Sans JP', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    @media (max-width: 480px) {
      .album-wrapper {
        max-width: 250px !important;
        width: 70vw !important;
        aspect-ratio: 1 / 1;
      }
      .track-name {
        font-size: 1.4rem !important;
      }
      .album-name {
        font-size: 1.1rem !important;
      }
      .artist-name {
        font-size: 1rem !important;
      }
      .container {
        padding: 1rem !important;
      }
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 1s ease, color 1s ease;
      text-align: center;
      overflow: hidden;
      background-color: #000000;
      color: #ffffff;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-width: 600px;
      width: 100%;
      padding: 2rem;
      transition: opacity 1s ease;
      margin-top: 6rem;
    }
    .album-wrapper {
      position: relative;
      width: 100%;
      max-width: 400px;
      aspect-ratio: 1 / 1;
      margin-bottom: 1.2rem;
    }
    .album-cover {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }
    .album-cover:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    }
    .track-info {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }
    .track-name, .album-name, .artist-name {
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.35);
    }
    .track-name {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.15rem;
    }
    .album-name {
      font-size: 1.5rem;
      opacity: 0.9;
      margin-bottom: 0.15rem;
    }
    .artist-name {
      font-size: 1.25rem;
      opacity: 0.8;
    }
    .loading {
      font-size: 1.5rem;
    }
    .error-message {
      color: #ff6b6b;
      margin-top: 1rem;
    }
    .fade {
      opacity: 1;
    }
    .fade-out {
      opacity: 0;
    }
    .lyrics {
      position: relative;
      margin-top: 1.5rem;
      font-size: 1.1rem;
      line-height: 1.6;
      max-height: 3.2em; /* 限制最多顯示兩行 (2 * 1.6em) */
      overflow: hidden;
      text-align: center;
      opacity: 0.9;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 1rem;
      white-space: normal; /* 允許自動換行 */
    }

    .lyrics-line {
      font-size: clamp(0.8rem, 2.5vw, 1.2rem);
      line-height: 1.4;
      padding: 0 1rem;
      word-break: break-word;
      position: absolute;
      width: 100%;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s ease;
     
    }
    .lyrics-line.active {
      opacity: 1;
    }
  </style>
  <script type="module">
    import { loadLyrics, setTrackFetcher, hideLyrics } from './js/lyrics-loader.js';
    import { getSaturatedDominantColor, getSafeTextColor } from './js/color-utils.js';
  
    window.loadLyrics = loadLyrics;
    window.setTrackFetcher = setTrackFetcher;
    window.getSaturatedDominantColor = getSaturatedDominantColor;
    window.getSafeTextColor = getSafeTextColor;
    window.hideLyrics = hideLyrics;
  </script>
  
</head>
<body>
  <div class="container fade" id="app">
    <div class="loading">載入中...</div>
  </div>
  
  <script>
    let currentTrackId = null;
    let currentAlbumImgUrl = null;
    let lastRenderTimestamp = 0;
    let isFirstLoad = true;
    let grayPixels = 0;


    
    
    function getSafeTextColor(bg) {
  
      const brightness = (bg.r * 299 + bg.g * 587 + bg.b * 114) / 1000;
      
      // 最低對比度參數 
      const contrastFactor = 120;
      
      let r, g, b;
      
      if (brightness < 128) {
        // 如果背景暗，使文字稍亮
        r = Math.min(255, bg.r + contrastFactor);
        g = Math.min(255, bg.g + contrastFactor);
        b = Math.min(255, bg.b + contrastFactor);
      } else {
        // 如果背景亮，使文字稍暗
        r = Math.max(0, bg.r - contrastFactor);
        g = Math.max(0, bg.g - contrastFactor);
        b = Math.max(0, bg.b - contrastFactor);
      }
      
      // 調整顏色飽和度
      const { h, s, l } = rgbToHsl(r, g, b);
      const bgHsl = rgbToHsl(bg.r, bg.g, bg.b);
      
      
      const adjustedColor = hslToRgb(
        bgHsl.h, 
        Math.min(1, s * 1.2),
        l 
      );
      
      return adjustedColor;
    }
    // 儲存歌曲資訊
    function saveSongInfo(songData) {
      if (!songData || !songData.track) return;
      
      // 為了避免儲存太多資料，只儲存必要的資訊
      const savedData = {
        track: {
          name: songData.track.name,
          artist: songData.track.artist,
          album: songData.track.album,
          image: songData.track.image,
          '@attr': songData.track['@attr'],
          savedAt: new Date().toISOString()
        }
      };
      
      localStorage.setItem('lastfm_last_song', JSON.stringify(savedData));
    }

    // 從 localStorage 讀取歌曲資訊
    function getSavedSongInfo() {
      const savedData = localStorage.getItem('lastfm_last_song');
      if (!savedData) return null;
      
      try {
        return JSON.parse(savedData);
      } catch (e) {
        console.error('Failed to parse saved song data:', e);
        return null;
      }
    }

    function renderTextOnly(track) {

      const app = document.getElementById('app');
      const nameEl = app.querySelector('.track-name');
      const albumEl = app.querySelector('.album-name');
      const artistEl = app.querySelector('.artist-name');

      const isNowPlaying = track['@attr']?.nowplaying === 'true';

      if (nameEl && albumEl && artistEl) {
        nameEl.textContent = track.name;
        albumEl.textContent = track.album['#text'];
        artistEl.textContent = track.artist['#text'];

        if (isNowPlaying) {
          loadLyrics(track);
          const lyricsDiv = document.getElementById('lyrics');
          if (lyricsDiv) lyricsDiv.style.display = 'flex';
        } else {
          hideLyrics(); 
        }
      } else {
        renderFull(track);
      }
    }


    function renderFull(track) {
        const app = document.getElementById('app');
        const albumImgUrl = track.image.find(img => img.size === "extralarge")['#text'];
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.src = albumImgUrl;

        // 創建Last.fm的URL
        const trackUrl = `https://www.last.fm/music/${encodeURIComponent(track.artist['#text'])}/_/${encodeURIComponent(track.name)}`;
        const albumUrl = `https://www.last.fm/music/${encodeURIComponent(track.artist['#text'])}/${encodeURIComponent(track.album['#text'])}`;
        const artistUrl = `https://www.last.fm/music/${encodeURIComponent(track.artist['#text'])}`;

        img.onload = () => {
          const rawColor = getSaturatedDominantColor(img);
          let color = rawColor;
          const textColor = getSafeTextColor(color);
          const bgColor = `rgb(${color.r}, ${color.g}, ${color.b})`;
          const fontColor = `rgb(${textColor.r}, ${textColor.g}, ${textColor.b})`;

          app.classList.add('fade-out');

          setTimeout(() => {
            app.innerHTML = `
              <div class="album-wrapper">
                <img src="${albumImgUrl}" alt="${track.album['#text']}" class="album-cover">
              </div>
              <div class="track-info">
                <a href="${trackUrl}" target="_blank" class="track-name">${track.name}</a>
                <a href="${albumUrl}" target="_blank" class="album-name">${track.album['#text']}</a>
                <a href="${artistUrl}" target="_blank" class="artist-name">${track.artist['#text']}</a>
                <div class="lyrics" id="lyrics"></div>
              </div>
            `;

            document.body.style.backgroundColor = bgColor;
            document.body.style.color = fontColor;
            app.classList.remove('fade-out');
            app.classList.add('fade');
            currentAlbumImgUrl = albumImgUrl;

            const links = app.querySelectorAll('a');
            links.forEach(link => {
              link.style.color = fontColor;
              link.style.textDecoration = 'none';
            });

            const isNowPlaying = track['@attr']?.nowplaying === 'true';

            if (isNowPlaying) {
              loadLyrics(track);
            } else {
              hideLyrics(); 
            }

          }, 800);

        };



         
        }
        
    async function renderApp(songData, isFirstLoad = false) {
      if (!songData?.track) return;

      const track = songData.track;
      const isNowPlaying = track['@attr']?.nowplaying === 'true';
      window.currentTrackData = track;

      
      // 如果不是首次載入，只在正在播放時更新
      if (!isFirstLoad && !isNowPlaying) return;
      
      // 如果是正在播放的歌曲，儲存到 localStorage
      if (isNowPlaying) {
        saveSongInfo(songData);
      }

      const trackId = `${track.name}-${track.artist['#text']}`;
      const albumImgUrl = track.image.find(img => img.size === "extralarge")['#text'];

      if (trackId === currentTrackId) return;
      currentTrackId = trackId;

      if (albumImgUrl === currentAlbumImgUrl) {
        renderTextOnly(track);
      } else {
        renderFull(track);
      }
    }

    async function getSongInfo() {
      try {
        const res = await fetch('https://lastfm-last-played.biancarosa.com.br/potatomatoyota/latest-song'); 
        if (!res.ok) throw new Error('Fetch failed');
        const data = await res.json();
        return data;
      } catch (err) {
        console.error('Error fetching song info:', err);
        // 嘗試從本地存儲讀取
        const cachedData = getSavedSongInfo();
        if (cachedData) {
          // 有快取資料就直接使用
          return cachedData;
        }
        
        // 如果都沒有就顯示錯誤
        const app = document.getElementById('app');
        app.innerHTML = `<div class="error-message">無法獲取歌曲資訊，請稍後再試。</div>`; 
        return null;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      //  當前歌曲傳進 lyrics-loader
      setTrackFetcher(() => window.currentTrackData);

      const latestSong = await getSongInfo();
      if (latestSong) {
        renderApp(latestSong, true);
      } else {
        // 快取
        const cachedSong = getSavedSongInfo();
        if (cachedSong) {
          renderApp(cachedSong, true);
        } else {
          const app = document.getElementById('app');
          app.innerHTML = `<div class="error-message">無法獲取歌曲資訊，請稍後再試。</div>`;
        }
      }

      isFirstLoad = false;

      // 設定定時器定期檢查更新
      setInterval(async () => {
        const song = await getSongInfo();
        if (song) {
          renderApp(song, false);
        }
      }, 3000);
    });


   
  </script>
</body>
</html>